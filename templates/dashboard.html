<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Dashboard</title>
    <link rel="stylesheet" href="../static/dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <h1>Email Dashboard</h1>

        <!-- Buttons for fetching emails and downloading report -->
        <div style="text-align: center;">
            <button id="start-fetching" onclick="startFetchingEmails()">Start Fetching Emails</button>
            <button id="download-report" style="display:none;" onclick="downloadReport()">Download Report</button>
            <button id="logout-button" onclick="logout()" style="margin-left: 10px;">Logout</button> <!-- Logout button -->
        </div>

        <!-- Success/Error modal -->
        <div id="modal-success" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p id="modal-message">Email fetching operation was successful!</p>
            </div>
        </div>

        <!-- Email output section -->
        <div id="email-output"></div>

    </div>

    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        const startButton = document.getElementById('start-fetching');
        const downloadButton = document.getElementById('download-report');
        const emailOutput = document.getElementById('email-output');
        const modal = document.getElementById('modal-success');
        const modalMessage = document.getElementById('modal-message');

        // Function to display the modal with a custom message
        function openModal(message) {
            modalMessage.innerText = message;
            modal.style.display = 'block';
        }

        // Close modal
        const span = document.getElementsByClassName('close')[0];
        span.onclick = function() {
            modal.style.display = 'none';
        };

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // Function to start fetching emails
        function startFetchingEmails() {
            startButton.style.display = 'none'; // Hide the Start button
            socket.emit('start_fetching_emails');  // Start fetching emails
        }

        // Append fetched emails to the email output section
        socket.on('email_update', function(email) {
            const emailData = `
                <div class="email-entry">
                    <div class="email-header">
                        <h2>From: ${email.from}</h2>
                        <h3>Subject: ${email.subject}</h3>
                        <p class="date-time"><strong>Date:</strong> ${email.date} <strong>Time:</strong> ${email.time}</p>
                        <p class="status"><strong>Status:</strong> ${email.status}</p>
                    </div>
                    <div class="email-body">
                        <p>${email.body}</p>
                    </div>
                </div>
            `;
            emailOutput.innerHTML += emailData;
        });

        // Show the Download Report button when the fetching is complete
        socket.on('fetch_complete', function() {
            openModal('Email fetching operation was successful!');  // Show success modal
            downloadButton.style.display = 'inline-block'; // Show the Download button
        });

        // Function to download the generated report
        function downloadReport() {
            window.location.href = "/download_report";  // Redirect to the download route
        }

        // Function to handle logout
        function logout() {
            window.location.href = "/logout";  // Redirect to logout route
        }
    </script>
</body>
</html>
